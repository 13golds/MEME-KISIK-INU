<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kisik — Dashboard</title>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase JS UMD v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
</head>
<body class="min-h-screen flex flex-col items-center justify-center bg-[#111] text-white p-6">

  <h1 class="text-3xl font-semibold mb-6">Welcome to Kisik ☕</h1>

  <p id="user-email" class="mb-8 text-lg">Loading…</p>

  <div class="w-full max-w-md bg-[#1a1a1a] p-6 rounded-xl shadow-lg">
    <h2 class="text-xl font-medium mb-4">Your referral link</h2>
    <div class="flex gap-2 mb-4">
      <input id="referral-link" type="text" readonly class="flex-1 px-3 py-2 rounded text-black" />
      <button id="copyBtn" class="bg-orange-400 hover:bg-orange-500 px-4 py-2 rounded">Copy</button>
    </div>
    <div id="copyMsg" class="text-green-400 text-sm hidden">Copied ✓</div>
  </div>

  <!-- Simple buying guide -->
  <div class="w-full max-w-md mt-10 bg-[#1a1a1a] p-6 rounded-xl shadow-lg">
    <h2 class="text-xl font-medium mb-4">How to buy KISIK</h2>
    <ol class="list-decimal list-inside space-y-1 text-sm">
      <li>Install a Phantom wallet and add some SOL.</li>
      <li>Open <a href="https://jup.ag" class="underline text-orange-300" target="_blank">Jupiter</a> and search “KISIK”.</li>
      <li>Swap SOL → KISIK and confirm the transaction.</li>
    </ol>
  </div>

  <button id="logoutBtn" class="mt-12 underline text-orange-300">Logout</button>

<script>
const SUPABASE_URL  = 'https://rrfcfkqxybhbouqytiwg.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJyZmNma3F4eWJoYm91cXl0aXdnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM3Mjk5NDMsImV4cCI6MjA1OTMwNTk0M30.A8_EQjO1PiCSFe5V9VEPAWsfraG6Opw4UeB9X-yBav0';
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

const emailEl   = document.getElementById('user-email');
const refInput  = document.getElementById('referral-link');
const copyBtn   = document.getElementById('copyBtn');
const copyMsg   = document.getElementById('copyMsg');
const logoutBtn = document.getElementById('logoutBtn');

(async () => {
  // Check current session
  const { data: { session } } = await supabase.auth.getSession();
  if (!session) {
    location.replace('login.html');
    return;
  }
  const user = session.user;
  emailEl.textContent = `Logged in as ${user.email}`;

  // Fetch existing referral code or create a new one
  let { data: profile, error } = await supabase
    .from('profiles')
    .select('referral_code')
    .eq('id', user.id)
    .single();

  let code;
  if (error && error.code === 'PGRST116') { // no row → create profile
    code = crypto.randomUUID().slice(0, 8);
    await supabase.from('profiles').insert({ id: user.id, referral_code: code });
  } else if (profile) {
    code = profile.referral_code;
  } else if (error) {
    console.error(error);
    alert('Error loading profile');
  }

  if (code) {
    refInput.value = `${location.origin}/signup.html?ref=${code}`;
  }
})();

// Copy link to clipboard
copyBtn.addEventListener('click', async () => {
  await navigator.clipboard.writeText(refInput.value);
  copyMsg.classList.remove('hidden');
  setTimeout(() => copyMsg.classList.add('hidden'), 2000);
});

logoutBtn.addEventListener('click', async () => {
  await supabase.auth.signOut();
  location.replace('login.html');
});
</script>
</body>
</html>
